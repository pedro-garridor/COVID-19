---
title: "Evolución COVID-19 en España"
author: "Pedro Garrido Rodríguez"
date: "`r format(Sys.time(), '%d de %B de %Y')`"
output:
  html_document:
    df_print: paged
    highlight: kate
    number_sections: yes
    theme: spacelab
    toc: yes
    toc_float: yes
---

```{r, results=F}
setwd("~/COVID-19/")
library(ggplot2); library(reshape2)
```

# Obtención de los datos

Para analizar la evolución del COVID-19 en España se obtiene información sobre casos positivos, hospitalizados, fallecidos y altas hospitalarias. Son datos diarios, agregados y desglosados por comunidad autónoma. Estos datos se obtienen del [GitHub de datadista](https://github.com/datadista/datasets/tree/master/COVID%2019) y proceden de los informes oficiales del [Ministerio de Sanidad](https://www.mscbs.gob.es/profesionales/saludPublica/ccayes/alertasActual/nCov-China/situacionActual.htm) y el [Instituto de Salud Carlos III](https://covid19.isciii.es/).

```{r Crear un directorio para almacenar los ficheros de datos}
if(dir.exists("Datos") == F) {
  dir.create("Datos")
}
```

```{bash Obtener los datos de GitHub, results=F}
cd ./Datos/

# Casos agregados
wget -N https://raw.githubusercontent.com/datadista/datasets/master/COVID%2019/ccaa_covid19_casos.csv

# Altas agregadas
wget -N https://raw.githubusercontent.com/datadista/datasets/master/COVID%2019/ccaa_covid19_altas.csv

# Fallecidos agregados
wget -N https://raw.githubusercontent.com/datadista/datasets/master/COVID%2019/ccaa_covid19_fallecidos.csv

# Hospitalizados agregados
wget -N https://raw.githubusercontent.com/datadista/datasets/master/COVID%2019/ccaa_covid19_hospitalizados.csv

cd ..
```

```{r Introduccir los datos en R}
# Se elinima la primera columna porque contiene el código de provincia y no es necesario

casos <- read.csv("./Datos/ccaa_covid19_casos.csv", check.names = F)
casos <- casos[,2:ncol(casos)]

hospitalizados <- read.csv("./Datos/ccaa_covid19_hospitalizados.csv", check.names = F)
hospitalizados <- hospitalizados[,2:ncol(hospitalizados)]

fallecidos <- read.csv("./Datos/ccaa_covid19_fallecidos.csv", check.names = F)
fallecidos <- fallecidos[,2:ncol(fallecidos)]

altas <- read.csv("./Datos/ccaa_covid19_altas.csv", check.names = F)
altas <- altas[,2:ncol(altas)]
```

# Procesamiento de los datos

1. Apilar los datos para facilitar su manejo.

```{r Crear dataframes apilados para facilitar su procesamiento}
casos.stacked <- melt(casos, id.vars = c("CCAA"))
names(casos.stacked) <- c("CCAA", "Fecha", "Casos")

hospitalizados.stacked <- melt(hospitalizados, id.vars = c("CCAA"))
names(hospitalizados.stacked) <- c("CCAA", "Fecha", "Hospitalizados")

fallecidos.stacked <- melt(fallecidos, id.vars = c("CCAA"))
names(fallecidos.stacked) <- c("CCAA", "Fecha", "Fallecidos")

altas.stacked <- melt(altas, id.vars = c("CCAA"))
names(altas.stacked) <- c("CCAA", "Fecha", "Altas")
```

2. Crear un dataset único con los datos conjuntos.

```{r Crear dataframe único, message=F}
library(dplyr)
df <- left_join(casos.stacked, fallecidos.stacked)
df <-  left_join(df, altas.stacked)
df <- left_join(df, hospitalizados.stacked)
```

3. Crear datasets auxiliares para las representaciones.

```{r Crear datasets auxiliares}
casos.stacked.aux <- subset(casos.stacked, CCAA != "Total")
hospitalizados.stacked.aux <- subset(hospitalizados.stacked, CCAA != "Total")
fallecidos.stacked.aux <- subset(fallecidos.stacked, CCAA != "Total")
altas.stacked.aux <- subset(altas.stacked, CCAA != "Total")
```

4. Crear datasets para el Estado y la CARM.

```{r Crear datasets para el Estado y la CARM}
df.total <- subset(df, CCAA == "Total")
df.total <- df.total[,2:ncol(df.total)]
df.total.stacked <- melt(df.total, id.vars = "Fecha")

df.CARM <- subset(df, CCAA == "Murcia")
df.CARM <- df.CARM[,2:ncol(df.CARM)]
df.CARM.stacked <- melt(df.CARM, id.vars = "Fecha")
```

5. Cálculo de velocidades de crecimiento diario de nuevos casos.

```{r Calcular velocidades}
velocidades.ESP <- rep(0, nrow(df.total))
for (i in 2:nrow(df.total)) {
  velocidades.ESP[i] = df.total$Casos[i] - df.total$Casos[i - 1]
}

velocidades.CARM <- rep(0, nrow(df.total))
velocidades.CARM <- rep(0, nrow(df.total))
for (i in 2:nrow(df.CARM)) {
  velocidades.CARM[i] = df.CARM$Casos[i] - df.CARM$Casos[i - 1]
}

velocidad <- data.frame(
  "Fecha" = df.total$Fecha,
  "España" = velocidades.ESP,
  "Murcia" = velocidades.CARM
)

velocidad.CARM <- data.frame(
  "Fecha" = df.CARM$Fecha,
  "Velocidad" = velocidades.CARM
)

velocidad.stacked <- melt(velocidad, id.vars = "Fecha")
```

# Representaciones

## Gráficos acumulados

### Código
```{r Generación de gráficos, warning=F}
global.ESP <- ggplot(df.total.stacked, aes(x = Fecha)) +
  geom_bar(aes(y = value, fill = variable), stat = "identity", position = "dodge2") + 
  geom_vline(xintercept = "2020-03-14", linetype = "dashed", color = "red") +
  geom_vline(xintercept = "2020-03-26", linetype = "dashed", color = "blue") +
  theme(axis.text.x = element_text(angle = 90), legend.title=element_blank()) +
  labs(title = "Evolución del COVID-19 en España", 
       subtitle = "Datos agregados", 
       x = "Fecha", y = "Casos")

global.CARM <- ggplot(df.CARM.stacked, aes(x = Fecha)) +
  geom_bar(aes(y = value, fill = variable), stat = "identity", position = "dodge2") + 
  geom_vline(xintercept = "2020-03-14", linetype = "dashed", color = "red") +
  geom_vline(xintercept = "2020-03-26", linetype = "dashed", color = "blue") +
  theme(axis.text.x = element_text(angle = 90), legend.title=element_blank()) +
  labs(title = "Evolución del COVID-19 en la Región de Murcia", 
       subtitle = "Datos agregados", 
       x = "Fecha", y = "Casos")

casos.bar <- ggplot(casos.stacked.aux, aes(x = Fecha)) +
  geom_bar(aes(y = Casos, fill = CCAA), color = "black", stat = "identity") + 
  geom_vline(xintercept = "2020-03-14", linetype = "dashed", color = "red") +
  geom_vline(xintercept = "2020-03-26", linetype = "dashed", color = "blue") +
  theme(axis.text.x = element_text(angle = 90), legend.title=element_blank()) +
  labs(title = "Evolución del COVID-19 en España por CCAA", 
       subtitle = "Número de casos agregados", 
       x = "Fecha", y = "Positivos")

hospitalizados.bar <- ggplot(hospitalizados.stacked.aux, aes(x = Fecha)) +
  geom_bar(aes(y = Hospitalizados, fill = CCAA), color = "black", stat = "identity") + 
  geom_vline(xintercept = "2020-03-26", linetype = "dashed", color = "blue") +
  theme(axis.text.x = element_text(angle = 90), legend.title=element_blank()) +
  labs(title = "Evolución del COVID-19 en España por CCAA", 
       subtitle = "Número de hospitalizados agregados", 
       x = "Fecha", y = "Hospitalizados")

fallecidos.bar <- ggplot(fallecidos.stacked.aux, aes(x = Fecha)) +
  geom_bar(aes(y = Fallecidos, fill = CCAA), color = "black", stat = "identity") + 
  geom_vline(xintercept = "2020-03-14", linetype = "dashed", color = "red") +
  geom_vline(xintercept = "2020-03-26", linetype = "dashed", color = "blue") +
  theme(axis.text.x = element_text(angle = 90), legend.title=element_blank()) +
  labs(title = "Evolución del COVID-19 en España por CCAA", 
       subtitle = "Número de fallecidos agregados", 
       x = "Fecha", y = "Fallecidos")

altas.bar <- ggplot(altas.stacked.aux, aes(x = Fecha)) +
  geom_bar(aes(y = Altas, fill = CCAA), color = "black", stat = "identity") + 
  geom_vline(xintercept = "2020-03-14", linetype = "dashed", color = "red") +
  geom_vline(xintercept = "2020-03-26", linetype = "dashed", color = "blue") +
  theme(axis.text.x = element_text(angle = 90), legend.title=element_blank()) +
  labs(title = "Evolución del COVID-19 en España por CCAA", 
       subtitle = "Número de altas hospitalarias agregadas", 
       x = "Fecha", y = "Altas hospitalarias")

casos.line <- ggplot(casos.stacked, aes(x = Fecha, y = Casos, group = CCAA, color = CCAA)) +
  geom_line() + geom_point() +
  geom_vline(xintercept = "2020-03-14", linetype = "dashed", color = "red") +
  geom_vline(xintercept = "2020-03-26", linetype = "dashed", color = "blue") +
  theme(axis.text.x = element_text(angle = 90), legend.title=element_blank()) +
  labs(title = "Evolución del COVID-19 en España por CCAA", 
       subtitle = "Número de casos agregados", 
       x = "Fecha", y = "Positivos")

hospitalizados.line <- ggplot(hospitalizados.stacked, 
                              aes(x = Fecha, y = Hospitalizados, group = CCAA, color = CCAA)) +
  geom_line() + geom_point() +
  geom_vline(xintercept = "2020-03-26", linetype = "dashed", color = "blue") +
  theme(axis.text.x = element_text(angle = 90), legend.title=element_blank()) +
  labs(title = "Evolución del COVID-19 en España por CCAA", 
       subtitle = "Número de hospitalizados agregados", 
       x = "Fecha", y = "Hospitalizados")

fallecidos.line<- ggplot(fallecidos.stacked, 
                         aes(x = Fecha, y = Fallecidos, group = CCAA, color = CCAA)) +
  geom_line() + geom_point() +
  geom_vline(xintercept = "2020-03-14", linetype = "dashed", color = "red") +
  geom_vline(xintercept = "2020-03-26", linetype = "dashed", color = "blue") +
  theme(axis.text.x = element_text(angle = 90)) +
  labs(title = "Evolución del COVID-19 en España por CCAA", 
       subtitle = "Número de fallecidos agregados", 
       x = "Fecha", y = "Fallecidos")

altas.line <- ggplot(altas.stacked, aes(x = Fecha, y = Altas, group = CCAA, color = CCAA)) +
  geom_line() + geom_point() +
  geom_vline(xintercept = "2020-03-14", linetype = "dashed", color = "red") +
  geom_vline(xintercept = "2020-03-26", linetype = "dashed", color = "blue") +
  theme(axis.text.x = element_text(angle = 90), legend.title=element_blank()) +
  labs(title = "Evolución del COVID-19 en España por CCAA", 
       subtitle = "Número de altas hospitalarias agregadas", 
       x = "Fecha", y = "Altas hospitalarias")
```

### Representaciones

```{r Representaciones, warning=F}
global.ESP; global.CARM
casos.line; casos.bar
hospitalizados.line; hospitalizados.bar
fallecidos.line; fallecidos.bar
altas.line; altas.bar
```

## Velocidades de expansión

```{r Gráficos de velocidad}
vel.plot <- ggplot(velocidad.stacked, aes(x = Fecha, y = value, group = variable, color = variable)) +
  geom_line() + geom_point() +
  geom_vline(xintercept = "2020-03-14", linetype = "dashed", color = "red") +
  geom_vline(xintercept = "2020-03-26", linetype = "dashed", color = "blue") +
  theme(axis.text.x = element_text(angle = 90), legend.title=element_blank()) +
  labs(title = "Evolución del COVID-19 en España",
       subtitle = "Velocidad de expansión",
       x = "Fecha", y = "Casos nuevos / día"
       )

vel.plot.CARM <- ggplot(velocidad.CARM, aes(x = Fecha, y = Velocidad, group = 1, color = "red")) +
  geom_line() + geom_point() +
  geom_vline(xintercept = "2020-03-14", linetype = "dashed", color = "red") +
  geom_vline(xintercept = "2020-03-26", linetype = "dashed", color = "blue") +
  theme(axis.text.x = element_text(angle = 90)) +
  guides(color = F) +
  labs(title = "Evolución del COVID-19 en la Región de Murcia",
       subtitle = "Velocidad de expansión",
       x = "Fecha", y = "Casos nuevos / día"
       )

vel.plot
vel.plot.CARM
```

## Exportación de los gráficos generados

Los gráficos presentados anteriormente se exportan a la carpeta `Graficas` a una resolución de 1920x1080 px.

```{r Guardar gráficos, warning=F}
if (dir.exists("Graficas") == F) {
  dir.create("Graficas")
}

ggsave("global_ESP.png", 
       plot = global.ESP,
       path = "./Graficas",
       width = 50.8, 
       height = 28.58, 
       units = 'cm', 
       dpi = 300)

ggsave("global_CARM.png", 
       plot = global.CARM,
       path = "./Graficas",
       width = 50.8, 
       height = 28.58, 
       units = 'cm', 
       dpi = 300)

ggsave("casos_bar.png", 
       plot = casos.bar,
       path = "./Graficas",
       width = 50.8, 
       height = 28.58, 
       units = 'cm', 
       dpi = 300)

ggsave("hospitalizados_bar.png", 
       plot = hospitalizados.bar,
       path = "./Graficas",
       width = 50.8, 
       height = 28.58, 
       units = 'cm', 
       dpi = 300)

ggsave("fallecidos_bar.png", 
       plot = fallecidos.bar,
       path = "./Graficas",
       width = 50.8, 
       height = 28.58, 
       units = 'cm', 
       dpi = 300)

ggsave("altas_bar.png", 
       plot = altas.bar,
       path = "./Graficas",
       width = 50.8, 
       height = 28.58, 
       units = 'cm', 
       dpi = 300)

ggsave("casos_line.png", 
       plot = casos.line,
       path = "./Graficas",
       width = 50.8, 
       height = 28.58, 
       units = 'cm', 
       dpi = 300)

ggsave("hospitalizados_line.png", 
       plot = hospitalizados.line,
       path = "./Graficas",
       width = 50.8, 
       height = 28.58, 
       units = 'cm', 
       dpi = 300)

ggsave("fallecidos_line.png", 
       plot = fallecidos.line,
       path = "./Graficas",
       width = 50.8, 
       height = 28.58, 
       units = 'cm', 
       dpi = 300)

ggsave("altas_line.png", 
       plot = altas.line,
       path = "./Graficas",
       width = 50.8, 
       height = 28.58, 
       units = 'cm', 
       dpi = 300)

ggsave("velocidad.png", 
       plot = vel.plot,
       path = "./Graficas",
       width = 50.8, 
       height = 28.58, 
       units = 'cm', 
       dpi = 300)

ggsave("velocidad_CARM.png", 
       plot = vel.plot.CARM,
       path = "./Graficas",
       width = 50.8, 
       height = 28.58, 
       units = 'cm', 
       dpi = 300)
```

